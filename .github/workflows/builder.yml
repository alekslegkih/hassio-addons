name: Build and Publish Add-ons

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  detect-changed-addons:
    runs-on: ubuntu-latest
    outputs:
      addons: ${{ steps.changed-addons.outputs.addons }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed addons
        id: changed-addons
        run: |
          # Определяем базовый коммит для сравнения
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            BASE=HEAD~1
          else
            BASE=HEAD
          fi

          # Получаем изменённые файлы
          CHANGED_FILES=$(git diff --name-only "$BASE" HEAD)
          
          # Извлекаем корневые папки
          CHANGED_DIRS=$(echo "$CHANGED_FILES" | cut -d'/' -f1 | sort -u)
          
          KNOWN_ADDONS="simple-dlna nc_user_files_backup gotify_server_ha"
          SELECTED=()
          
          for dir in $CHANGED_DIRS; do
            if [[ " $KNOWN_ADDONS " == *" $dir "* ]] && [ -f "$dir/config.yaml" ]; then
              SELECTED+=("$dir")
            fi
          done
          
          # Если тег — строим всё
          if [[ ${{ github.ref }} == refs/tags/* ]]; then
            SELECTED=("simple-dlna" "nc_user_files_backup")
          fi
          
          # Формируем JSON вручную (без jq, без sed)
          if [ ${#SELECTED[@]} -eq 0 ]; then
            JSON='[]'
          else
            JSON="["
            for i in "${!SELECTED[@]}"; do
              if [ $i -gt 0 ]; then JSON="$JSON,"; fi
              JSON="$JSON\"${SELECTED[$i]}\""
            done
            JSON="$JSON]"
          fi
          
          echo "Addons to build: $JSON"
          echo "addons=$JSON" >> $GITHUB_OUTPUT

  build-and-publish:
    needs: detect-changed-addons
    if: ${{ needs.detect-changed-addons.outputs.addons != '[]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        addon: ${{ fromJson(needs.detect-changed-addons.outputs.addons) }}
        arch: [aarch64, amd64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        run: |
          if [[ ${{ github.ref }} == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(grep -oP 'version:\s*["'\'']\K[^"'\'']+' "./${{ matrix.addon }}/config.yaml")
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.addon }}
          platforms: linux/${{ matrix.arch }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.addon }}-${{ matrix.arch }}:${{ env.VERSION }}
            ghcr.io/${{ github.repository_owner }}/${{ matrix.addon }}-${{ matrix.arch }}:latest